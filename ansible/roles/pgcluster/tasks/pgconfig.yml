---
- name: wal.conf
  template: src=wal.conf dest="{{PG_ETC}}/conf.d/wal.conf" force=no owner=postgres group=postgres
  register: walconf
  notify: restart postgres
  tags:
  - cluster
  - config
  - wal

- name: set wal_archive in wal.conf
  lineinfile: dest="{{PG_ETC}}/conf.d/wal.conf" regexp="^ *wal_log_hints *=" line="wal_log_hints = on"
  when: not walconf.changed
  notify: restart postgres
  tags:
  - cluster
  - config
  - wal

- name: set wal_archive in wal.conf
  lineinfile: dest="{{PG_ETC}}/conf.d/wal.conf" regexp="^ *wal_keep_segments *=" line="wal_keep_segments = {{wal_keep_segments}}"
  when: not walconf.changed and PG_VERSION != 9.6
  notify: restart postgres
  tags:
  - cluster
  - config
  - wal

- name: pg_hba.conf
  pg_hba: 
    databases="{{item[0]}}" 
    users=repmgr 
    source="{{hostvars[item[1]].ansible_default_ipv4.address}}/32"
    method=trust
    dest="{{PG_ETC}}/pg_hba.conf"
  with_nested:
    - [ replication, repmgr ]
    - "{{play_hosts}}"
  register: pg_hbaconf
  notify: reload postgres
  tags:
  - cluster
  - pg_hba

- name: start postgres
  debug:
    msg: 'start postgres'
  notify: start postgres

- name: force all notified handlers to run at this point, not waiting for normal sync points
  meta: flush_handlers

- name: check is_master
  command: 'Not yet implemented'
  register: is_master
  tags:
  - cluster
  - setup

- name: user repmgr
  become_user: postgres
  postgresql_user: name=repmgr role_attr_flags=SUPERUSER
  when: is_master.rc = 0
  tags:
  - cluster
  - repmgr
  - pgusers

- name: searchpath
  become_user: postgres
  shell: echo 'ALTER USER repmgr SET search_path TO "repmgr_{{pg_cluster|lower}}", "$user", public;' | /usr/local/bin/psql
  tags:
  - cluster
  - setup
  - pgusers

- name: database repmgr
  become_user: postgres
  postgresql_db: name=repmgr owner=repmgr state="{{item}}"
  with_items:
    - absent
    - present
  tags:
  - cluster
  - repmgr
  - db

- name: register master
  become_user: postgres
  shell: "{{PG_BIN}}/repmgr -f {{repmgr_conf}} master register"
  tags:
  - cluster
  - repmgr
  - register
